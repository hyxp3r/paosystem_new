{% extends "main/index.html" %}
{% load static %}


{% block link %}
<link rel="stylesheet" href="{% static 'oopk/css/style.css' %}"> 
{% endblock %}

{% block content %}

<div class="row">
    <div class="card shadow">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">Информация по отчету </h6> 
    </div>
    
    <div class="card-body">    
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Номер отчета</th>
                        <th>Дата создания</th>
                        <th>Наименование</th>
                        <th>Создатель</th>
                        <th>Комментарий к отчету</th>
                        
    
                    </tr>
                </thead>
                <tbody>
    
                
                {% for report in reports %}
                <tr>
                    <td class = "text-center">{{report.pk}}</td>
                    <td class = "text-center"> {{report.created_time}}</td>
         
                    <td class = "text-center"><a href="{{report.url}}" id = "report">{{report.name}}</a></td>
                    <td class = "text-center">{{report.user.get_FIO}}</td>
                    <td class = "text-center">{% if report.comment %}
                        {{report.comment}}
                    {%endif%}</td>
                    <td>
                        <a href="#" class="delete-item" data-item-id="{{ report.pk }}" data-name = "{{report.name}}">
                          <i class="fa fa-times-circle text-danger"></i>
                        </a>
                      </td>

                </tr>
                {% endfor %}
    
                
    
                </tbody>
            </table>
        </div>

        <div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog" aria-labelledby="confirm-delete-label">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="confirm-delete-label">Подтвердите удаление</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                    <div class = "modal-body-text">

                    </div>
                    <div class="text-center">
                        <div id="spinner-container" class="mt-3"></div>
                      </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                  <button type="button" class="btn btn-danger" id="confirm-delete-button">Удалить</button>
                </div>
              </div>
            </div>
          </div>

        {% if reports.has_other_pages %}
    <nav class = "text-center">
        <ul class="pagination justify-content-center">
            {% if reports.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{reports.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
            {% endif %}

            {% for i in reports.paginator.page_range %}
                {% if reports.number == i %}
                    <li class="page-item active">
                        <a class="page-link" href="#">{{ i }} <span class="sr-only">(current)</span></a>
                    </li>
                {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if reports.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ reports.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
{% endif %}
    </div>
    </div>
        
    </div>


    {% endblock %}

{% block scripts %}



<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


<script>
    $(function() {
      // Обработчик нажатия на крестик
      $('.delete-item').on('click', function(e) {
        e.preventDefault();
        var itemId = $(this).data('item-id'); 

        $('.modal-body-text').html("Вы действительно хотите удалить отчет " + "'" + "<b>" + $(this).data("name") +"</b>" + "'" + "?")
        $('#confirm-delete-modal').modal('show');
        
        // Обработчик нажатия на кнопку "Удалить" в модальном окне
        $('#confirm-delete-button').on('click', function() {
            $(this).prop('disabled', true); // Отключаем кнопку удаления
            $('.modal-footer .btn-secondary').prop('disabled', true); // Отключаем кнопку отмены
            $('.modal-body-text').html("")
             $('#spinner-container').html('<strong>Отчет удаляется, пожалуйста подождите</strong><br><br><div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>'); // Добавляем крутящийся значок загрузки
        
             $.ajax({
                url: '/oopk/oopk/report/gettableone/delete-item',
                type: 'POST',
                data: {
                itemId: itemId,
                },
                success: function(response) {
                // Обработка успешного удаления
                $('#confirm-delete-modal').modal('hide');
                location.reload();
                // Дополнительные действия после успешного удаления, если необходимо
                },
                error: function() {
                // Обработка ошибки удаления
                $('.modal-body').html('Ошибка при удалении элемента.');
                $('#confirm-delete-button').remove(); // Удаление кнопки удаления
                $('.modal-footer .btn-secondary').prop('disabled', false); // Включаем кнопку отмены
                }
            });
        
        
      
          //window.location.href = '/delete-item/' + itemId + '/';
        });
      });
    });
    </script>

{% endblock %}